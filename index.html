<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>射爆地瓜球</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    body {
      background: url('market_background.jpg') no-repeat center center fixed;
      background-size: cover;
      font-family: sans-serif;
    }
    canvas {
      display: block;
    }
    #startOverlay, #poopOverlay, #medalPopup {
      position: absolute;
      z-index: 99;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 20px 40px;
      border-radius: 10px;
      font-size: 20px;
      display: none;
      text-align: center;
    }
    #score {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 24px;
      background: rgba(255,255,255,0.8);
      padding: 6px 12px;
      border-radius: 8px;
      z-index: 10;
      font-weight: bold;
    }
    #medalPopup {
      animation: glow 1s ease-in-out infinite alternate;
    }
    @keyframes glow {
      from {
        box-shadow: 0 0 10px #fff;
      }
      to {
        box-shadow: 0 0 20px gold;
      }
    }
  </style>
</head>
<body>
  <div id="score">你已射爆 0 顆地瓜球</div>
  <div id="startOverlay">點擊開始掉炸地瓜球</div>
  <div id="poopOverlay">糟糕！你被地瓜球丟屎了。<br/>點擊按我繼續</div>
  <div id="medalPopup"></div>
  <canvas id="game"></canvas>
  <script>
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const startOverlay = document.getElementById("startOverlay");
    const poopOverlay = document.getElementById("poopOverlay");
    const medalPopup = document.getElementById("medalPopup");
    const scoreDisplay = document.getElementById("score");

    let started = false;
    let score = 0;
    const potatoes = [];
    const lasers = [];
    const poopParticles = [];

    const normalImages = [];
    const cryFaces = [];
    for (let i = 1; i <= 10; i++) {
      const img = new Image();
      img.src = `normal_potato${i}.png`;
      normalImages.push(img);
    }
    for (let i = 1; i <= 7; i++) {
      const img = new Image();
      img.src = `shoot_potato${i}.png`;
      cryFaces.push(img);
    }
    const poopImg = new Image();
    poopImg.src = 'poop_attack.png';

    class Potato {
      constructor(x, y, type) {
        this.x = x;
        this.y = y;
        this.type = type;
        this.img = normalImages[type];
        this.cry = cryFaces[Math.floor(Math.random() * cryFaces.length)];
        this.size = 60;
        this.speed = 1 + Math.random();
        if (type === 5) this.speed = 0.5;
        if (type === 8) this.speed = 2;
        this.hit = false;
        this.life = (type === 3) ? Math.ceil(Math.random() * 3) : 1;
      }
      update() {
        if (this.hit) return;
        if (this.type === 9) return; // 疑問地瓜不動
        this.y += this.speed;
      }
      draw() {
        const img = this.hit ? this.cry : this.img;
        ctx.drawImage(img, this.x, this.y, this.size, this.size);
      }
    }

    function spawnPotato() {
      const x = Math.random() * (canvas.width - 60);
      const type = Math.floor(Math.random() * 10);
      potatoes.push(new Potato(x, 0, type));
    }

    function drawPoopParticles() {
      poopParticles.forEach((p, i) => {
        p.x += p.vx;
        p.y += p.vy;
        p.scale += 0.01;
        p.rot += 0.1;
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.rot);
        ctx.drawImage(poopImg, -15 * p.scale, -15 * p.scale, 30 * p.scale, 30 * p.scale);
        ctx.restore();
        if (p.y > canvas.height + 50) poopParticles.splice(i, 1);
      });
    }

    function showMedal(score) {
      let text = '';
      if (score === 20) text = "🥉 地瓜碎星者<br>你的彈射，讓地瓜碎成宇宙微塵";
      if (score === 50) text = "🥈 暗影射手・滅地瓜流<br>你的手速，地瓜球夫婦嚇得連夜跑走";
      if (score === 100) text = "👑 地瓜毀滅神話<br>妳是地瓜的惡夢、宇宙的傳說！";
      if (text) {
        medalPopup.innerHTML = text;
        medalPopup.style.display = 'block';
        setTimeout(() => medalPopup.style.display = 'none', 3000);
      }
    }

    function animate() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      potatoes.forEach(p => {
        p.update();
        p.draw();
      });
      drawPoopParticles();
      requestAnimationFrame(animate);
    }

    canvas.addEventListener("click", e => {
      if (!started) return;
      const mx = e.clientX, my = e.clientY;
      potatoes.forEach((p, i) => {
        if (!p.hit && mx > p.x && mx < p.x + p.size && my > p.y && my < p.y + p.size) {
          p.life--;
          if (p.type === 0 && Math.random() < 0.2) {
            for (let j = 0; j < 6; j++) {
              poopParticles.push({
                x: p.x + 30,
                y: p.y + 30,
                vx: (Math.random() - 0.5) * 10,
                vy: Math.random() * 5,
                rot: 0,
                scale: 0.5 + Math.random() * 0.5
              });
            }
          }
          if (p.type === 1) {
            p.type = 2;
            p.img = normalImages[2];
            return;
          }
          if (p.life <= 0) {
            p.hit = true;
            score++;
            scoreDisplay.innerText = `你已射爆 ${score} 顆地瓜球`;
            showMedal(score);
          }
        }
      });
    });

    function randomPoopAttack() {
      if (Math.random() < 0.01) {
        poopOverlay.style.display = 'block';
        setTimeout(() => poopOverlay.style.display = 'none', 2000);
      }
    }

    setInterval(() => {
      if (!started) return;
      spawnPotato();
      randomPoopAttack();
    }, 1000);

    startOverlay.style.display = 'block';
    startOverlay.addEventListener('click', () => {
      startOverlay.style.display = 'none';
      started = true;
    });

    poopOverlay.addEventListener('click', () => poopOverlay.style.display = 'none');
    animate();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>射爆地瓜球</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: linear-gradient(to bottom right, #ffe6f0, #ffd6f6);
      font-family: "Noto Sans", sans-serif;
    }

    #score {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 22px;
      background: rgba(255, 255, 255, 0.9);
      padding: 8px 16px;
      border-radius: 12px;
      z-index: 1000;
      font-weight: bold;
    }

    .potato {
      position: absolute;
      cursor: pointer;
      height: 80px;
      pointer-events: auto;
    }

    .float {
      animation: float 2s ease-in-out infinite;
    }
    .zigzag {
      animation: zigzag 3s linear infinite;
    }
    .bounce {
      animation: bounce 1s ease-in-out infinite;
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes zigzag {
      0% { transform: translateX(0) translateY(0); }
      25% { transform: translateX(-20px) translateY(10px); }
      50% { transform: translateX(20px) translateY(0); }
      75% { transform: translateX(-20px) translateY(-10px); }
      100% { transform: translateX(0) translateY(0); }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    #startOverlay, #medalPopup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.9);
      padding: 30px 50px;
      font-size: 24px;
      border-radius: 12px;
      text-align: center;
      z-index: 2000;
      box-shadow: 0 0 20px #ff69b4;
    }

    #startOverlay button, #medalPopup button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      background: hotpink;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .poop {
      position: absolute;
      width: 40px;
      transform-origin: center;
      animation: poopFly 3s ease-out forwards;
      z-index: 999;
    }

    @keyframes poopFly {
      0% { transform: scale(0.2) rotate(0deg); opacity: 1; }
      100% { transform: scale(2) translateY(-120vh) rotate(1080deg); opacity: 0; }
    }

    /* 🌪️ 彩虹💩龍捲風動畫 */
    @keyframes poopTornado {
      0% {
        transform: perspective(600px) rotate(0deg) scale(0.3) translate(0, 0);
        opacity: 1;
      }
      40% {
        transform: perspective(600px) rotate(540deg) scale(1.2) translateX(50px) translateY(-50px);
        opacity: 1;
      }
      70% {
        transform: perspective(600px) rotate(900deg) scale(2) translateX(-70px) translateY(-200px);
        opacity: 0.9;
      }
      100% {
        transform: perspective(600px) rotate(1260deg) scale(2.6) translateX(0) translateY(-120vh);
        opacity: 0;
      }
    }
    .poop-tornado {
      position: absolute;
      width: 60px;
      transform-origin: center;
      animation: poopTornado 3s ease-out forwards;
      z-index: 1500;
    }

    #poopOverlay {
      display: none;
      position: fixed;
      width: 100vw;
      height: 100vh;
      top: 0;
      left: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 3000;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      color: white;
      font-size: 32px;
      text-shadow: 2px 2px 4px black;
      overflow: hidden;
    }

.bigPoop {
  position: absolute;
  top: -200px;
  font-size: 150px;
  animation: fallDown 1.5s ease-in forwards;
}

    @keyframes fallDown {
      0% { transform: translateY(-200px) rotate(0deg); opacity: 1; }
      70% { transform: translateY(40vh) rotate(360deg); opacity: 1; }
      100% { transform: translateY(40vh) rotate(720deg); opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="score">你已射爆 0 顆地瓜球</div>
  <div id="startOverlay">
    點擊開始掃射地瓜球<br>
    <button onclick="startGame()">開始！</button>
  </div>
  <div id="medalPopup" style="display:none">
    <div id="medalText"></div>
    <button onclick="closeMedal()">我收下了！</button>
  </div>
  <div id="poopOverlay">
    <div>💩 糟糕，你被地瓜球丟屎攻擊了！</div>
    <div class="bigPoop" id="bigPoop">💩</div>
  </div>
  <canvas id="laserCanvas"></canvas>

  <script>
    const potatoTypes = Array.from({length: 10}, (_, i) => `normal_potato${i+1}.png`);
    const shootFaces = Array.from({length: 7}, (_, i) => `shoot_potato${i+1}.png`);
    const gameArea = document.body;
    let score = 0;
    let awardedMedals = {};
    let balancedQueue = [...potatoTypes];
    const movingPotatoes = [];

    const canvas = document.getElementById("laserCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const poopDataURI = (() => {
      const c = document.createElement("canvas");
      c.width = 40;
      c.height = 40;
      const ctx = c.getContext("2d");
      const grad = ctx.createRadialGradient(20, 20, 5, 20, 20, 20);
      grad.addColorStop(0, "#8B4513");
      grad.addColorStop(1, "#5A2E0C");
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(20, 20, 18, 0, Math.PI * 2);
      ctx.fill();
      ctx.font = "bold 16px sans-serif";
      ctx.fillStyle = "#fff";
      ctx.fillText("💩", 9, 26);
      return c.toDataURL("image/png");
    })();

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    function getNextPotato() {
      if (balancedQueue.length === 0) balancedQueue = [...potatoTypes];
      shuffle(balancedQueue);
      return balancedQueue.pop();
    }

    function startGame() {
      document.getElementById("startOverlay").style.display = "none";
      setInterval(spawnPotato, 2000);
      setInterval(() => {
        if (Math.random() < 0.6) fullScreenPoop();
      }, 15000);
      requestAnimationFrame(updatePotatoPositions);
    }

    function spawnPotato() {
      const img = document.createElement("img");
      img.src = getNextPotato();
      img.classList.add("potato");
      img.style.left = Math.random() * (window.innerWidth - 100) + "px";
      img.style.top = Math.random() * (window.innerHeight - 100) + "px";
      img.dataset.hitCount = 0;

      let speed = 1;
      if (img.src.includes("normal_potato5")) speed = 0.5;
      if (img.src.includes("normal_potato9")) speed = 2;
      if (img.src.includes("normal_potato7")) speed = 1.2;

      img.dataset.speed = speed;
      img.dataset.directionX = Math.random() > 0.5 ? 1 : -1;
      img.dataset.directionY = Math.random() > 0.5 ? 1 : -1;

      if (img.src.includes("normal_potato8")) {
        img.classList.add("bounce");
      } else if (img.src.includes("normal_potato6")) {
        img.classList.add("zigzag");
      } else {
        img.classList.add("float");
      }

      img.onclick = (e) => {
        shootLaser(e.clientX, e.clientY);

        if (img.src.includes("normal_potato2")) {
          img.src = "normal_potato3.png";
          return;
        }

        if (img.src.includes("normal_potato4")) {
          img.dataset.hitCount++;
          if (img.dataset.hitCount < Math.floor(Math.random() * 2) + 2) return;
        }

        const originalSrc = img.src;
        if (originalSrc.includes("normal_potato1.png")) {
          if (Math.random() < 0.5) poopAttack(img);
        }

        let variant = Math.floor(Math.random() * shootFaces.length);
        img.src = shootFaces[variant];
        img.style.pointerEvents = "none";

        setTimeout(() => {
          img.remove();
        }, 500);

        score++;
        updateScore();
        checkMedal();
      };

      gameArea.appendChild(img);

      if (!img.src.includes("normal_potato10")) {
        movingPotatoes.push(img);
      }
    }

    function updatePotatoPositions() {
      movingPotatoes.forEach((img) => {
        let x = parseFloat(img.style.left);
        let y = parseFloat(img.style.top);
        let dx = parseFloat(img.dataset.directionX);
        let dy = parseFloat(img.dataset.directionY);
        let speed = parseFloat(img.dataset.speed);

        x += dx * speed;
        y += dy * speed;

        if (x <= 0 || x >= window.innerWidth - 80) img.dataset.directionX *= -1;
        if (y <= 0 || y >= window.innerHeight - 80) img.dataset.directionY *= -1;

        img.style.left = x + "px";
        img.style.top = y + "px";
      });
      requestAnimationFrame(updatePotatoPositions);
    }

    function shootLaser(x, y) {
      ctx.strokeStyle = "red";
      ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.moveTo(window.innerWidth / 2, window.innerHeight);
      ctx.lineTo(x, y);
      ctx.stroke();
      setTimeout(() => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }, 100);
    }

    /* 🌪️ 改造後龍捲風彩虹💩攻擊 */
    function poopAttack(fromImg) {
      const cx = parseFloat(fromImg.style.left);
      const cy = parseFloat(fromImg.style.top);
      const poopCount = 8;

      for (let i = 0; i < poopCount; i++) {
        const poop = document.createElement("img");
        poop.src = "poop_attack.png";
        poop.classList.add("poop-tornado");

        const offsetX = (Math.random() - 0.5) * 120;
        const offsetY = (Math.random() - 0.5) * 80;
        poop.style.left = cx + offsetX + "px";
        poop.style.top = cy + offsetY + "px";

        poop.style.animationDelay = `${i * 0.15}s`;
        poop.style.transform = `rotate(${Math.random() * 360}deg)`;

        gameArea.appendChild(poop);
        setTimeout(() => poop.remove(), 3000);
      }

      const centerPoop = document.createElement("img");
      centerPoop.src = "poop_attack.png";
      centerPoop.classList.add("poop-tornado");
      centerPoop.style.left = cx + "px";
      centerPoop.style.top = cy + "px";
      centerPoop.style.zIndex = 1600;
      centerPoop.style.animation = "poopTornado 3.2s ease-in-out forwards";
      centerPoop.style.filter = "brightness(1.5) drop-shadow(0 0 10px gold)";
      gameArea.appendChild(centerPoop);
      setTimeout(() => centerPoop.remove(), 3200);
    }

    function fullScreenPoop() {
      const overlay = document.getElementById("poopOverlay");
      const bigPoop = document.getElementById("bigPoop");

      overlay.style.display = "flex";
      document.body.style.pointerEvents = "none";
      bigPoop.style.top = "-200px";
      bigPoop.style.animation = "fallDown 1.5s ease-in forwards";

      setTimeout(() => {
        overlay.style.display = "none";
        document.body.style.pointerEvents = "auto";
      }, 6500);
    }

    function updateScore() {
      document.getElementById("score").innerText = `你已射爆 ${score} 顆地瓜球`;
    }

    function checkMedal() {
      const popup = document.getElementById("medalPopup");
      const text = document.getElementById("medalText");
      if (score === 20 && !awardedMedals["20"]) {
        awardedMedals["20"] = true;
        text.innerHTML = `🎉 <b>獲得勳章：地瓜碎星者 🥉</b><br>你的彈射，讓地瓜碎成宇宙微塵`;
        popup.style.display = "block";
      } else if (score === 50 && !awardedMedals["50"]) {
        awardedMedals["50"] = true;
        text.innerHTML = `🎉 <b>獲得勳章：暗影射手・滅地瓜流 🥈</b><br>你的手速，地瓜球夫婦嚇得連夜跑走`;
        popup.style.display = "block";
      } else if (score === 100 && !awardedMedals["100"]) {
        awardedMedals["100"] = true;
        text.innerHTML = `🎉 <b>獲得勳章：地瓜毀滅神話 👑</b><br>你是地瓜的惡夢、宇宙的傳說！`;
        popup.style.display = "block";
      }
    }

    function closeMedal() {
      document.getElementById("medalPopup").style.display = "none";
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>射爆地瓜球</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: linear-gradient(135deg, #ffe6f0, #ffd9ec);
      font-family: sans-serif;
    }
    canvas {
      display: block;
    }
    #startOverlay, #poopOverlay, #medalPopup {
      position: absolute;
      z-index: 99;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      padding: 20px 40px;
      border-radius: 10px;
      font-size: 20px;
      display: none;
      text-align: center;
    }
    #score {
      position: absolute;
      top: 10px;
      left: 10px;
      font-size: 24px;
      background: rgba(255,255,255,0.8);
      padding: 6px 12px;
      border-radius: 8px;
      z-index: 10;
      font-weight: bold;
    }
    #medalPopup {
      animation: glow 1s ease-in-out infinite alternate;
    }
    @keyframes glow {
      from { box-shadow: 0 0 10px #fff; }
      to { box-shadow: 0 0 20px #ff69b4; }
    }
  </style>
</head>
<body>
  <div id="score">你已射爆 0 顆地瓜球</div>
  <div id="startOverlay">點擊開始掃射地瓜球</div>
  <div id="poopOverlay">💩 糟糕，你被地瓜球丟屎了！</div>
  <div id="medalPopup"></div>
  <canvas id="gameCanvas"></canvas>
  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const scoreDiv = document.getElementById("score");
    const startOverlay = document.getElementById("startOverlay");
    const poopOverlay = document.getElementById("poopOverlay");
    const medalPopup = document.getElementById("medalPopup");

    let potatoes = [];
    let score = 0;
    let gameStarted = false;
    let medalThresholds = [
      { score: 20, name: "🥉 地瓜碎星者", desc: "你的彈射，讓地瓜碎成宇宙微塵" },
      { score: 50, name: "🥈 暗影射手・滅地瓜流", desc: "你的手速，地瓜球夫婦嚇得連夜跑走" },
      { score: 100, name: "👑 地瓜毀滅神話", desc: "妳是地瓜的惡夢、宇宙的傳說！" },
    ];
    let medalIndex = 0;

    const potatoImgs = [];
    const shootImgs = [];
    for (let i = 1; i <= 10; i++) {
      const img = new Image();
      img.src = `normal_potato${i}.png`;
      potatoImgs.push(img);
    }
    for (let i = 1; i <= 7; i++) {
      const img = new Image();
      img.src = `shoot_potato${i}.png`;
      shootImgs.push(img);
    }
    const poopImg = new Image();
    poopImg.src = "poop_attack.png";

    let allImgs = [...potatoImgs, ...shootImgs, poopImg];
    let loadedCount = 0;
    allImgs.forEach(img => img.onload = () => {
      loadedCount++;
      if (loadedCount === allImgs.length) {
        startOverlay.style.display = "block";
      }
    });

    document.body.addEventListener("click", () => {
      if (!gameStarted) {
        startOverlay.style.display = "none";
        gameStarted = true;
        addPotato();
        setInterval(addPotato, 2000);
        requestAnimationFrame(gameLoop);
        poopAttackLoop();
      }
    });

    class Potato {
      constructor(img, x, y, speed, type) {
        this.img = img;
        this.x = x;
        this.y = y;
        this.baseY = y;
        this.speed = speed;
        this.type = type;
        this.hitCount = 0;
        this.dead = false;
        this.angle = 0;
        this.jumpDir = 1;
        this.pauseTimer = 0;
        this.targetX = Math.random() * canvas.width;
        this.targetY = Math.random() * canvas.height;
      }

      update() {
        if (this.dead) return;
        if (this.type === "static") return;
        if (this.type === "curve") {
          this.angle += 0.05;
          this.x += this.speed;
          this.y = this.baseY + Math.sin(this.angle) * 20;
        } else if (this.type === "jump") {
          this.y += this.jumpDir * this.speed;
          if (this.y < this.baseY - 30 || this.y > this.baseY + 30) this.jumpDir *= -1;
        } else if (this.type === "stopgo") {
          if (this.pauseTimer > 0) {
            this.pauseTimer--;
            return;
          }
          this.x += (this.targetX - this.x) * 0.01;
          this.y += (this.targetY - this.y) * 0.01;
          if (Math.random() < 0.005) this.pauseTimer = 100;
        } else {
          this.x += this.speed;
        }
      }

      draw() {
        if (!this.dead) ctx.drawImage(this.img, this.x, this.y);
      }
    }

    function addPotato() {
      const index = Math.floor(Math.random() * potatoImgs.length);
      const img = potatoImgs[index];
      const type = getPotatoType(index);
      const speed = getPotatoSpeed(index);
      const x = Math.random() * (canvas.width - 100);
      const y = Math.random() * (canvas.height - 100);
      potatoes.push(new Potato(img, x, y, speed, type));
    }

    function getPotatoType(i) {
      return {
        1: "stopgo",     // 探索
        2: "static",     // 疑問
        3: "normal",     // 嘔吐
        4: "multi",      // 吐舌
        5: "normal",     // 學問
        6: "slow",       // 學問
        7: "fast",       // 長腿
        8: "curve",      // 攤手
        9: "jump",       // 興奮
        10: "static",    // 疑問
      }[i + 1] || "normal";
    }

    function getPotatoSpeed(i) {
      return {
        6: 0.3,   // slow
        7: 4,     // fast
        8: 2,     // curve
        9: 2.5,   // jump
      }[i + 1] || 1.5;
    }

    function gameLoop() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      potatoes.forEach(p => { p.update(); p.draw(); });
      requestAnimationFrame(gameLoop);
    }

    canvas.addEventListener("click", (e) => {
      const clickX = e.clientX;
      const clickY = e.clientY;
      drawLaser(clickX, clickY);
      potatoes.forEach(p => {
        if (p.dead) return;
        if (clickX >= p.x && clickX <= p.x + p.img.width &&
            clickY >= p.y && clickY <= p.y + p.img.height) {
          handleHit(p);
        }
      });
    });

    function drawLaser(x, y) {
      ctx.strokeStyle = "red";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(canvas.width / 2, canvas.height);
      ctx.lineTo(x, y);
      ctx.stroke();
      setTimeout(() => {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }, 80);
    }

    function handleHit(p) {
      if (p.img === potatoImgs[1]) {
        p.img = potatoImgs[2]; return;
      }
      if (p.img === potatoImgs[3]) {
        p.hitCount++;
        if (p.hitCount < Math.floor(Math.random() * 3) + 1) return;
      }
      if (p.img === potatoImgs[0] && Math.random() < 0.2) showPoop();
      p.dead = true;
      p.img = shootImgs[Math.floor(Math.random() * shootImgs.length)];
      setTimeout(() => {
        potatoes.splice(potatoes.indexOf(p), 1);
      }, 500);
      score++;
      scoreDiv.innerText = `你已射爆 ${score} 顆地瓜球`;
      if (medalIndex < medalThresholds.length && score === medalThresholds[medalIndex].score) {
        showMedal(medalThresholds[medalIndex]);
        medalIndex++;
      }
    }

    function showMedal({ name, desc }) {
      medalPopup.innerHTML = `<h2>🎉 獲得勳章！</h2><p>${name}</p><p>${desc}</p><br><button onclick="medalPopup.style.display='none'">我收下了</button>`;
      medalPopup.style.display = "block";
    }

    function showPoop() {
      poopOverlay.style.display = "block";
      setTimeout(() => {
        poopOverlay.style.display = "none";
      }, 2000);
    }

    function poopAttackLoop() {
      setInterval(() => {
        if (Math.random() < 0.15) showPoop();
      }, 15000);
    }
  </script>
</body>
</html>
